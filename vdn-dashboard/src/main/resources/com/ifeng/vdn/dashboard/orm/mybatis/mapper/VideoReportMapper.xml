<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ifeng.vdn.dashboard.orm.mybatis.mapper.VideoReportMapper">
	
	<!-- <cache /> -->

	<select id="getAvlbDaily" parameterType="avlbDailyModel" resultType="avlbDailyModel">
		SELECT 
		  N.`TOTAL` AS numerator,
		  D.`TOTAL` AS denominator,
		  D.`CT`,
		  N.`TOTAL` / D.`TOTAL` AS avlb 
		FROM
		  (SELECT 
		    a.* 
		  FROM
		    `VDN_AVLB_DAILY` a 
		  WHERE a.`ERR` = '303000') N,
		  (SELECT 
		    b.* 
		  FROM
		    `VDN_AVLB_DAILY` b 
		  WHERE b.`ERR` = '208000') D 
		  
		WHERE N.`CT` = D.`CT` 
		
		ORDER BY `CT` ASC
	</select>

	<select id="getAvlbMinutely2" parameterType="avlbMinutelyModel" resultType="avlbMinutelyModel">
		SELECT DISTINCT
		  N.`TOTAL` AS numerator,
		  D.`TOTAL` AS denominator,
		  N.`CT`,
		  N.`TR`,
		  N.`TOTAL` / D.`TOTAL` AS avlb 
		FROM
		  (SELECT 
		    a.* 
		  FROM
		    `VDN_AVLB_MINUTELY` a 
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="nCode != null and nCode != ''">
				a.`ERR` = #{nCode}
			</if>
			<if test="daily != null">
				AND a.`CT` IN 
				<foreach collection="daily" item="ct" open="(" separator="," close=")">
					#{ct} 
				</foreach>
			</if>
		</trim>			    
		     ORDER BY a.`CT` DESC, a.`TR` ASC  ) N,
		  (SELECT 
		    b.* 
		  FROM
		    `VDN_AVLB_MINUTELY` b 
		    
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="dCode != null and dCode != ''">
				b.`ERR` = #{dCode}
			</if>
			<if test="daily != null">
				AND b.`CT` IN 
				<foreach collection="daily" item="ct" open="(" separator="," close=")">
					#{ct} 
				</foreach>
			</if>
		</trim>		    
		    
		    ORDER BY b.`CT` DESC, b.`TR` ASC) D 
		WHERE N.`CT` = D.`CT` 
		  AND N.`TR` = D.`TR` 
		ORDER BY N.`CT` DESC, N.`TR` ASC 
	</select>

	<select id="getAvlbMinutely" parameterType="avlbMinutelyModel" resultType="avlbMinutelyModel">
		SELECT 
		  `NUMERATOR`,
		  `DENOMINATOR`,
		  `CT`,
		  `TR`,
		  `NUMERATOR`/`DENOMINATOR` AS `AVLB` 
		FROM
		  `VDN_AVLB_MINUTELY_REPORT`
		  
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="daily != null">
				`CT` IN 
				<foreach collection="daily" item="ct" open="(" separator="," close=")">
					#{ct} 
				</foreach>
			</if>
		</trim>	
		 ORDER BY `CT` DESC, `TR` ASC
	</select>
</mapper>